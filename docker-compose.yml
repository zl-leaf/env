version: '2'

services:

### Application #############################
  application:
    image: tianon/true
    volumes:
      - ${APPLICATION}:/opt/htdoc

### Workspace #############################
  workspace:
    build:
      context: ./workspace
      args:
        - NODE_VERSION=${WORKSPACE_NODE_VERSION}
        - NODE_ENV=${NODE_ENV}
    volumes_from:
      - application
    depends_on:
      - application
    links:
      - platform:${PLATFORM_API_HOST}

### platform api #############################
  platform:
    build: ./platform
    volumes_from:
      - application
    volumes:
      - ${PLATFORM_NGINX_LOG_PATH}:/var/log/nginx
      - ${PLATFORM_NGINX_SITES_PATH}:/etc/nginx/sites-available
    ports:
      - "${PLATFORM_NGINX_HTTP_PORT}:80"
      - "${PLATFORM_NGINX_HTTPS_PORT}:443"
    depends_on:
      - application
    labels:
      service: platform
    logging:
      driver: json-file
      options:
        labels: "service"

### Web #############################
  web:
    build:
      context: ./web
      args:
        - NODE_ENV=${NODE_ENV}
    volumes_from:
      - application
    ports:
      - "${WEB_NODE_PORT}:8080"
    depends_on:
      - application
    links:
      - platform:${PLATFORM_API_HOST}
    labels:
      service: web
    logging:
      driver: json-file
      options:
        labels: "service"

### mysql #############################
  mysql:
    build:
      context: ./mysql
    environment:
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - TZ=${MYSQL_TIMEZONE}
    volumes:
      - ${MYSQL_DATA_PATH}:/var/lib/mysql
    ports:
      - "${MYSQL_PORT}:3306"
    labels:
      service: mysql
    logging:
      driver: json-file
      options:
        labels: "service"

  mysql-slave:
    build:
      context: ./mysql-slave
    environment:
      - MYSQL_DATABASE=${MYSQL_DATABASE_SLAVE}
      - MYSQL_USER=${MYSQL_USER_SLAVE}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD_SLAVE}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD_SLAVE}
      - TZ=${MYSQL_TIMEZONE}
    volumes:
      - ${MYSQL_DATA_PATH_SLAVE}:/var/lib/mysql
    ports:
      - "${MYSQL_PORT_SLAVE}:3306"
    links:
      - mysql:mysql-master
    labels:
      service: mysql
    logging:
      driver: json-file
      options:
        labels: "service"

### filebeat #############################
  filebeat:
    build:
      context: ./filebeat
    volumes:
      - ${FILE_BEAT_REGISTRY_FILE}:/var/lib/filebeat/registry
      - /var/lib/docker/containers:/var/lib/docker/containers

### logstash #############################
  logstash:
    build:
      context: ./logstash
    volumes_from:
      - application
    depends_on:
      - application
    ports:
       - "5044:5044"

### elasticsearch #############################
  elasticsearch:
    build:
      context: ./elasticsearch
    user: elasticsearch
    volumes:
       - ${ELASTIC_DATA}:/usr/share/elasticsearch/data
    ports:
       - "9200:9200"

### kibana #############################
  kibana:
    build:
      context: ./kibana
    ports:
      - 5601:5601
    links:
      - elasticsearch:${ELASTIC_HOST}
    environment:
      - ELASTICSEARCH_URL=http://${ELASTIC_HOST}:9200